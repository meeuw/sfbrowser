(function(j){var w;var h;var p;var E;var H;var D;var v;var t;var k;var n;var z;var f;var r;var e;var q;var A=-1;var y;var G;var x;var d;var c;var o;var b;var a;var s;var F;var m;var g;j.fn.extend(j.sfbrowser,{imageresize:function(J){w=J.trace;h=J.openDir;t=J.aPath;n=J.oTree;k=J.oSettings;z=J.mSfb;p=J.addContextItem;E=J.file;H=J.lang;D=J.moveWindowDown;v=J.resizeWindow;var I=j.sfbrowser;f=k.sfbpath+"plugins/imageresize/connectors/"+k.connector+"/imageresize."+k.connector;j(k.imageresize).prependTo(z.find("#fbwin")).hide();z.find("#sfbimgresize>div.sfbheader>h3").mousedown(D);z.find("div.cancelresize").text(k.lang.cancel).click(function(){j("#sfbimgresize").hide();j("#winbrowser").show();v()});z.find("div.resize").text(k.lang.resize).click(l);z.find("div.handle").attr("title",k.lang.dragMe).mousedown(C);z.find("div#crop").attr("title",k.lang.dragMe).mousedown(C);j("div#sfbimgresize>div.fbcontent>label[for=rszperc]").text(k.lang.scale);j("form#sfbsize legend:eq(0)").text(k.lang.resize+":");j("form#sfbsize label[for=rszW]").text(k.lang.width);j("form#sfbsize label[for=rszH]").text(k.lang.height);j("form#sfbsize input[name=rszW]").change(function(){x=Math.min(r.width,parseInt(j(this).val()));d=x/y;u()});j("form#sfbsize input[name=rszH]").change(function(){d=Math.min(r.height,parseInt(j(this).val()));x=d*y;u()});j("form#sfbsize legend:eq(1)").text(k.lang.crop+":");j("form#sfbsize label[for=crpW]").text(k.lang.width);j("form#sfbsize label[for=crpH]").text(k.lang.height);j("form#sfbsize input[name=crpX]").change(function(){b=parseInt(j(this).val());u()});j("form#sfbsize input[name=crpY]").change(function(){a=parseInt(j(this).val());u()});j("form#sfbsize input[name=crpW]").change(function(){c=parseInt(j(this).val());u()});j("form#sfbsize input[name=crpH]").change(function(){o=parseInt(j(this).val());u()});e=p("resize",k.lang.resize,function(){i()},0)}});j.extend(j.sfbrowser.imageresize,{resizeWindow:function(K,J){if(r){var L=j("#fbwin").width()-j("form#sfbsize").width()-20;var I=j("#fbwin").height()-70;G=Math.min(1,Math.min(L/r.width,I/r.height));j("div#sfbimgresize>div.fbcontent>span#rszperc").text(Math.round(G*100)+"%");j("#sfbimgresize div#org").css({width:(G*r.width)+"px",height:(G*r.height)+"px"});u()}},checkContextItem:function(J,I){e.css({display:J.width!=null&&J.height!=null?"block":"none"})}});function i(I){j("#winbrowser").hide();j("#sfbimgresize").show();r=E();y=r.width/r.height;m=c=x=r.width;g=o=d=r.height;s=F=b=a=0;j("#sfbimgresize>div.sfbheader>h3").text(k.lang.imgResize+": "+r.file);j("div#sfbrsimg>img").attr("src",k.sfbpath+t.join("")+r.file+"?"+Math.random());j.sfbrowser.imageresize.resizeWindow()}function C(I){s=b;F=a;m=c;g=o;var J=this;z.find("div.handle").each(function(K){if(j(this)[0]==J){A=K}});q=j(this);if(q[0]==j("div#crop")[0]){A=10}j("body").mousemove(B).mouseup(function(){j("body").unbind("mousemove",B);A=-1;q=null});I.stopPropagation();return false}function B(K){var M=q.parent();var I=Math.min(Math.max(0,Math.round((K.pageX-M.offset().left)/G)),r.width);var L=Math.min(Math.max(0,Math.round((K.pageY-M.offset().top)/G)),r.height);switch(A){case 10:b=I-c/2;a=L-o/2;break;case 8:x=I;d=L;break;default:for(var J=0;J<(A<4?2:1);J++){switch(((A%4)-J+4)%4){case 0:a=L;o=g-(a-F);break;case 1:c=I-b;break;case 2:o=L-a;break;case 3:b=I;c=m-(b-s);break}}}u();K.stopPropagation();return false}function u(){x=Math.max(1,x);d=Math.max(1,d);if(x/d>y){d=x/y}else{x=d*y}b=Math.max(Math.min(b,x-c),0);a=Math.max(Math.min(a,d-o),0);c=Math.max(1,Math.min(c,x-b));o=Math.max(1,Math.min(o,d-a));var M=x*G;var K=d*G;var O=b*G;var N=a*G;var I=c*G;var L=o*G;j("div#sfbrsimg>img").css({width:M+"px",height:K+"px"});j("#sfbimgresize div#crop").css({left:O+"px",top:N+"px",width:I+"px",height:L+"px"});j("div.handle:eq(8)").css({left:(M-6)+"px",top:(K-6)+"px"});j("div.handle:eq(0)").css({left:(O-6)+"px",top:(N-6)+"px"});j("div.handle:eq(1)").css({left:(O+I-6)+"px",top:(N-6)+"px"});j("div.handle:eq(2)").css({left:(O+I-6)+"px",top:(N+L-6)+"px"});j("div.handle:eq(3)").css({left:(O-6)+"px",top:(N+L-6)+"px"});j("div.handle:eq(4)").css({left:(O+I/2-6)+"px",top:(N-6)+"px"});j("div.handle:eq(5)").css({left:(O+I-6)+"px",top:(N+L/2-6)+"px"});j("div.handle:eq(6)").css({left:(O+I/2-6)+"px",top:(N+L-6)+"px"});j("div.handle:eq(7)").css({left:(O-6)+"px",top:(N+L/2-6)+"px"});var J=x/r.width;j("form#sfbsize input[name=rszW]").val(Math.round(x));j("form#sfbsize input[name=rszH]").val(Math.round(d));j("form#sfbsize input[name=crpX]").val(Math.round(b));j("form#sfbsize input[name=crpY]").val(Math.round(a));j("form#sfbsize input[name=crpW]").val(Math.round(c));j("form#sfbsize input[name=crpH]").val(Math.round(o))}function l(){w("sfb resizeSend");var J=j("form#sfbsize input[name=rszW]").val();var L=j("form#sfbsize input[name=rszH]").val();var N=j("form#sfbsize input[name=crpX]").val();var M=j("form#sfbsize input[name=crpY]").val();var I=j("form#sfbsize input[name=crpW]").val();var K=j("form#sfbsize input[name=crpH]").val();if(J==r.width&&L==r.height&&I==r.width&&K==r.height){w("sfb Will not resize to same size.")}else{w("sfb Sending resize request...");j.ajax({type:"POST",url:f,data:"a=bar&folder="+t.join("")+"&file="+r.file+"&w="+J+"&h="+L+"&cx="+N+"&cy="+M+"&cw="+I+"&ch="+K,dataType:"json",success:function(Q,P){if(typeof(Q.error)!="undefined"){if(Q.error!=""){w(H(Q.error));alert(H(Q.error))}else{r.width=I;r.height=K;r.tr.find("td:eq(4)").attr("abbr",I*K).text(I+" x "+K+" px");var O=j("#fbpreview").clone(true);j("#fbpreview").html("");j("#fbpreview").html(O.children());j("#sfbimgresize").hide();j("#winbrowser").show();v()}}}})}}})(jQuery);